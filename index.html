<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ ‚Äî –°—Ç—Ä–∏–º –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { overflow-x: hidden; }
    .glass { backdrop-filter: blur(14px); background: rgba(12, 17, 35, 0.7); }
    .scrollbar::-webkit-scrollbar { width: 6px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.6); border-radius: 12px; }
    
    .pip-video { 
      position: absolute; 
      bottom: 0.75rem; 
      right: 0.75rem; 
      width: 80px; 
      height: 60px; 
      border-radius: 10px; 
      border: 2px solid rgba(255,255,255,0.25); 
      object-fit: cover; 
      z-index: 10; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.45); 
    }
    .pip-video:hover { transform: scale(1.05); border-color: rgba(99, 102, 241, 0.6); }
    @media (min-width: 640px) { .pip-video { width: 120px; height: 90px; } }
    @media (min-width: 768px) { .pip-video { width: 160px; height: 120px; bottom: 1rem; right: 1rem; } }
    
    .main-video { width: 100%; height: 100%; object-fit: cover; background: #0f172a; }
    .video-container { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 1rem; overflow: hidden; }
    @media (max-width: 640px) { .video-container { aspect-ratio: 4/3; border-radius: 0.75rem; } }
    
    .fullscreen-btn { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 30; background: rgba(0,0,0,0.55); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 0.4rem; cursor: pointer; transition: all 0.2s; }
    .fullscreen-btn:hover { background: rgba(99, 102, 241, 0.55); }
    
    .waiting-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(8, 11, 26, 0.92); z-index: 5; gap: 0.5rem; text-align: center; padding: 1rem; }
    
    .pulse { position: relative; }
    .pulse::after { content: ""; position: absolute; inset: -8px; border-radius: 999px; border: 2px solid rgba(94,234,212,0.35); animation: pulse 1.8s infinite; }
    @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.9; } 100% { transform: scale(1.3); opacity: 0; } }
    
    .meter { width: 5px; background: linear-gradient(180deg, #22c55e, #ef4444); border-radius: 6px; height: 32px; overflow: hidden; position: relative; }
    @media (min-width: 640px) { .meter { height: 40px; width: 6px; } }
    .meter .level { position: absolute; bottom: 0; width: 100%; background: linear-gradient(180deg, #22c55e, #eab308, #ef4444); border-radius: 6px; }
    
    .no-media { background: linear-gradient(135deg, #1e293b, #334155); border: 2 dashed #475569; }
    .no-media-icon { font-size: 1.5rem; opacity: 0.3; }
    @media (min-width: 640px) { .no-media-icon { font-size: 2rem; } }
    
    .msg-actions button { opacity: 0; transition: opacity 0.2s; }
    .chat-card:hover .msg-actions button { opacity: 1; }
    @media (max-width: 768px) { .msg-actions button { opacity: 1; } }
    
    .tooltip { position: fixed; padding: 8px 10px; border-radius: 10px; background: rgba(15,23,42,0.9); border: 1px solid rgba(255,255,255,0.12); color: #e2e8f0; font-size: 12px; z-index: 100; pointer-events: none; opacity: 0; transform: translateY(4px); transition: opacity 0.2s ease, transform 0.2s ease; }
    .tooltip.show { opacity: 1; transform: translateY(0); }
    
    .fade-out { animation: fadeOut 0.4s forwards; }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-4px); } }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 60; }
    .modal-backdrop.show { display: flex; }
    .viewer-content img, .viewer-content video { max-height: 80vh; max-width: 90vw; border-radius: 16px; }
    
    .notification { position: fixed; top: 1rem; left: 1rem; right: 1rem; z-index: 100; max-width: 320px; padding: 0.75rem 1rem; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; color: #e2e8f0; font-size: 13px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); opacity: 0; transform: translateX(-20px); transition: all 0.3s ease; pointer-events: none; }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.hide { opacity: 0; transform: translateX(-20px); }
    
    /* Mobile controls */
    .video-controls { 
      position: absolute; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      z-index: 20; 
      padding: 0.5rem;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: center;
    }
    @media (min-width: 640px) {
      .video-controls { padding: 0.75rem; gap: 0.5rem; }
    }
    
    .video-controls button {
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      border-radius: 0.5rem;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      white-space: nowrap;
      transition: all 0.2s;
    }
    @media (min-width: 640px) {
      .video-controls button { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
    }
    .video-controls button:hover { background: rgba(0,0,0,0.8); }
    
    .video-status {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .control-btn-icon { display: inline; }
    .control-btn-text { display: none; }
    @media (min-width: 640px) {
      .control-btn-text { display: inline; }
    }
    
    /* Delete animation */
    .msg-deleting {
      animation: msgDelete 0.3s ease forwards;
    }
    @keyframes msgDelete {
      to { opacity: 0; transform: translateX(-20px) scale(0.95); height: 0; margin: 0; padding: 0; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="fixed inset-0 -z-10 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-700/30 via-slate-900 to-fuchsia-800/25"></div>
    <div class="absolute w-[900px] h-[900px] -top-48 -left-48 rounded-full bg-indigo-500/20 blur-[160px]"></div>
    <div class="absolute w-[700px] h-[700px] -bottom-40 -right-40 rounded-full bg-fuchsia-500/20 blur-[160px]"></div>
  </div>

  <header class="flex flex-wrap items-center justify-between gap-2 px-3 py-2 md:px-4 md:py-3 border-b border-white/10 glass sticky top-0 z-20">
    <div class="flex items-center gap-2 md:gap-3">
      <div class="h-8 w-8 md:h-10 md:w-10 rounded-xl md:rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-lg md:text-xl shadow-lg shadow-indigo-900/50">üìπ</div>
      <div>
        <h1 class="text-base md:text-xl font-semibold">–°—Ç—Ä–∏–º –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
        <p class="text-[10px] md:text-xs text-slate-400 hidden sm:block">P2P | –ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–∞</p>
      </div>
    </div>
    <div class="flex items-center gap-1.5 md:gap-2 text-[10px] md:text-xs flex-wrap">
      <span id="callStatus" class="px-2 py-0.5 md:px-3 md:py-1 rounded-full bg-white/10 border border-white/10 text-slate-200">–û–∂–∏–¥–∞–Ω–∏–µ</span>
      <span id="connectionQuality" class="px-2 py-0.5 md:px-3 md:py-1 rounded-full bg-amber-500/20 border border-amber-400/40 text-amber-100 hidden sm:inline-block">–°–∫–æ—Ä–æ—Å—Ç—å: ‚Äî</span>
      <span id="callTimer" class="px-2 py-0.5 md:px-3 md:py-1 rounded-full bg-emerald-500/15 border border-emerald-400/30 text-emerald-100">00:00</span>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-3 md:gap-4 p-2 md:p-4 max-w-6xl mx-auto">
    <section class="lg:col-span-2 space-y-3 md:space-y-4">
      <div class="video-container glass border border-white/10 shadow-2xl shadow-indigo-900/30">
        <video id="remoteVideo" class="main-video" autoplay playsinline></video>
        <div id="localVideoContainer" class="pip-video no-media flex items-center justify-center">
          <div class="text-center">
            <div class="no-media-icon">üìπ</div>
            <p class="text-[8px] md:text-xs text-slate-400 mt-1">–ù–µ—Ç –∫–∞–º–µ—Ä—ã</p>
          </div>
        </div>
        <video id="localVideo" class="pip-video hidden" autoplay muted playsinline></video>

        <div id="waitingOverlay" class="waiting-overlay">
          <div class="text-4xl md:text-5xl mb-2">üìû</div>
          <p class="text-slate-200 text-base md:text-lg">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
          <p class="text-slate-400 text-xs md:text-sm">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
        </div>

        <button id="fullscreenMain" class="fullscreen-btn text-white text-sm">‚õ∂</button>

        <div class="video-status">
          <div class="flex items-center gap-1.5 px-1.5 py-0.5 md:px-2 md:py-1 rounded-lg bg-black/40 border border-white/10">
            <div class="meter"><div id="level" class="level" style="height: 5%"></div></div>
            <span class="text-[10px] md:text-xs text-slate-200 hidden sm:inline">–ú–∏–∫—à.</span>
          </div>
          <div id="liveBadge" class="pulse px-2 py-0.5 md:px-3 md:py-1 rounded-full bg-rose-600/70 text-[10px] md:text-xs font-semibold border border-rose-200/30 shadow-lg shadow-rose-900/50">LIVE</div>
        </div>

        <div class="video-controls">
          <button id="toggleMic"><span class="control-btn-icon">üé§</span><span class="control-btn-text"> –ú–∏–∫—Ä–æ—Ñ–æ–Ω</span></button>
          <button id="toggleCam"><span class="control-btn-icon">üì∑</span><span class="control-btn-text"> –ö–∞–º–µ—Ä–∞</span></button>
          <button id="shareScreen"><span class="control-btn-icon">üñ•Ô∏è</span><span class="control-btn-text"> –≠–∫—Ä–∞–Ω</span></button>
          <button id="snapBtn"><span class="control-btn-icon">üì∏</span><span class="control-btn-text"> –°–∫—Ä–∏–Ω</span></button>
          <button id="recordBtn"><span class="control-btn-icon">‚è∫Ô∏è</span><span class="control-btn-text"> –ó–∞–ø–∏—Å—å</span></button>
        </div>
      </div>

      <div class="glass border border-white/10 rounded-xl p-3 md:p-4 space-y-3">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <h3 class="font-semibold text-sm">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
          <div class="flex gap-1.5 md:gap-2 flex-wrap">
            <button id="createOfferBtn" class="px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-xs md:text-sm transition">–°–æ–∑–¥–∞—Ç—å –∫–æ–¥</button>
            <button id="connectBtn" class="px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-xs md:text-sm transition">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="resetCall" class="px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-rose-600/80 hover:bg-rose-500 text-xs md:text-sm transition">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3">
          <div class="space-y-1">
            <label class="text-xs text-slate-400">–í–∞—à –∫–æ–¥</label>
            <div class="flex gap-2">
              <textarea id="inviteOut" rows="2" class="flex-1 px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-black/40 border border-white/10 text-[10px] md:text-xs font-mono resize-none" placeholder="–ù–∞–∂–º–∏—Ç–µ '–°–æ–∑–¥–∞—Ç—å –∫–æ–¥'"></textarea>
              <button id="copyInvite" class="px-2 py-1 rounded-lg bg-white/10 border border-white/10 text-xs hover:bg-white/20">üìã</button>
            </div>
          </div>
          <div class="space-y-1">
            <label class="text-xs text-slate-400">–ö–æ–¥ –¥—Ä—É–≥–∞</label>
            <textarea id="inviteIn" rows="2" class="w-full px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-black/40 border border-white/10 text-[10px] md:text-xs font-mono resize-none" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –¥—Ä—É–≥–∞"></textarea>
          </div>
        </div>

        <details class="mt-2">
          <summary class="text-xs font-semibold text-indigo-300 cursor-pointer">üìñ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</summary>
          <div class="mt-2 p-2 md:p-3 rounded-lg bg-white/5 border border-white/10">
            <ol class="text-[10px] md:text-xs text-slate-400 space-y-1 pl-4 list-decimal">
              <li><strong>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–¥:</strong> –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∫–æ–¥" –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ –ø–æ–ª—è "–í–∞—à –∫–æ–¥"</li>
              <li><strong>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É:</strong> –ü–µ—Ä–µ–¥–∞–π—Ç–µ –∫–æ–¥ –¥—Ä—É–≥—É –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º</li>
              <li><strong>–î—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:</strong> –î—Ä—É–≥ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞—à –∫–æ–¥ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
              <li><strong>–û–±–º–µ–Ω –∫–æ–¥–∞–º–∏:</strong> –î—Ä—É–≥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∞–º —Å–≤–æ–π –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞</li>
              <li><strong>–ì–æ—Ç–æ–≤–æ!</strong> P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</li>
            </ol>
          </div>
        </details>
      </div>
    </section>

    <aside class="glass border border-white/10 rounded-xl shadow-2xl shadow-indigo-900/30 flex flex-col h-[50vh] lg:h-[78vh]">
      <div class="flex items-center justify-between px-3 py-2 md:px-4 md:py-3 border-b border-white/5">
        <div>
          <h2 class="font-semibold text-sm">–ß–∞—Ç</h2>
          <p class="text-[10px] md:text-xs text-slate-400">DataChannel</p>
        </div>
        <div class="flex gap-1.5 md:gap-2">
          <button id="saveLog" class="text-[10px] md:text-xs px-1.5 py-0.5 md:px-2 md:py-1 rounded bg-white/10 border border-white/10 hover:bg-white/15">üíæ</button>
          <button id="clearBtn" class="text-[10px] md:text-xs px-1.5 py-0.5 md:px-2 md:py-1 rounded bg-white/10 border border-white/10 hover:bg-white/15">üóëÔ∏è</button>
        </div>
      </div>

      <div id="chat" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-2 scrollbar"></div>

      <div class="p-2 md:p-3 border-t border-white/5 space-y-2">
        <div id="replyBadge" class="hidden items-center justify-between px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-white/5 border border-white/10 text-[10px] md:text-xs">
          <span id="replyText" class="text-slate-200 truncate"></span>
          <button id="cancelReply" class="text-rose-300 ml-2">‚úï</button>
        </div>
        <div class="flex gap-1.5 md:gap-2 items-center">
          <button id="attachBtn" class="px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 transition text-sm">üìé</button>
          <input id="fileInput" type="file" class="hidden" accept="image/*,video/*,audio/*,.pdf,.zip,.txt,.doc,.docx" />
          <input id="messageInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 min-w-0 px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-indigo-400/60 text-xs md:text-sm" />
          <button id="emojiBtn" class="px-2 py-1.5 md:px-3 md:py-2 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 transition text-sm">üòä</button>
          <button id="sendBtn" class="px-3 py-1.5 md:px-4 md:py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm">‚û§</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- –†–∏—Å–æ–≤–∞–ª–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
  <div id="drawModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-2 md:p-6 overflow-y-auto">
    <div class="bg-slate-900 rounded-xl md:rounded-2xl border border-white/10 shadow-2xl w-full max-w-4xl overflow-hidden my-auto">
      <div class="flex items-center justify-between px-3 py-2 md:px-5 md:py-4 border-b border-white/10">
        <div>
          <h3 class="font-semibold text-sm md:text-base">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
          <p class="text-[10px] md:text-xs text-slate-400 mt-0.5">–†–∏—Å—É–π—Ç–µ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏</p>
        </div>
        <div class="flex gap-2 md:gap-3 text-xs md:text-sm items-center flex-wrap">
          <div class="flex items-center gap-1.5">
            <span class="text-slate-400 hidden sm:inline">–¶–≤–µ—Ç:</span>
            <input type="color" id="brushColor" value="#f472b6" class="h-8 w-8 md:h-10 md:w-10 p-0 border-0 bg-transparent rounded cursor-pointer" />
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-slate-400 hidden sm:inline">–†–∞–∑–º–µ—Ä:</span>
            <input id="brushSize" type="range" min="2" max="30" value="8" class="w-20 md:w-32 accent-indigo-400" />
          </div>
          <button id="clearCanvas" class="px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20 transition">üîÑ –°–±—Ä–æ—Å</button>
          <button id="closeDraw" class="px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-rose-500/20 border border-rose-400/30 hover:bg-rose-500/40 text-rose-200 transition">‚úï</button>
        </div>
      </div>
      <div class="p-3 md:p-6 bg-slate-950 flex justify-center">
        <canvas id="drawCanvas" class="rounded-xl border-2 border-white/20 bg-slate-900 touch-none shadow-2xl" style="max-width: 100%; max-height: 70vh;"></canvas>
      </div>
      <div class="flex justify-between items-center px-3 py-3 md:px-5 md:py-4 border-t border-white/10 bg-slate-900/50">
        <p class="text-[10px] md:text-xs text-slate-500">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ PNG, JPG, GIF</p>
        <div class="flex gap-2">
          <button id="cancelDraw" class="px-3 py-1.5 md:px-4 md:py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20 text-xs md:text-sm transition">–û—Ç–º–µ–Ω–∞</button>
          <button id="sendDrawing" class="px-4 py-1.5 md:px-6 md:py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-xs md:text-sm font-medium transition">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–≤–∏–¥–µ–æ -->
  <div id="viewer" class="modal-backdrop">
    <div class="viewer-content relative bg-slate-900/80 border border-white/10 rounded-xl md:rounded-2xl p-2 md:p-4 shadow-2xl">
      <button id="viewerClose" class="absolute -top-2 -right-2 md:-top-3 md:-right-3 h-7 w-7 md:h-8 md:w-8 rounded-full bg-black/70 text-white border border-white/20 text-sm">‚úï</button>
      <div id="viewerBody" class="flex justify-center items-center"></div>
    </div>
  </div>

  <div id="tooltip" class="tooltip hidden md:block"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É -->
  <div id="micInstructionModal" class="modal-backdrop">
    <div class="bg-slate-900 rounded-xl md:rounded-2xl border border-white/10 shadow-2xl w-full max-w-md p-4 md:p-6 m-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</h3>
        <button id="closeMicInstruction" class="h-8 w-8 rounded-full bg-white/10 text-white flex items-center justify-center">‚úï</button>
      </div>
      
      <div class="space-y-4 text-sm text-slate-300">
        <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</p>
        
        <div class="space-y-2">
          <h4 class="font-medium text-slate-100">–î–ª—è iOS (Safari):</h4>
          <ol class="list-decimal list-inside space-y-1">
            <li>–ù–∞–∂–º–∏—Ç–µ <strong>¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã¬ª</strong> –≤ –≤–µ—Ä—Ö–Ω–µ–º –ª–µ–≤–æ–º —É–≥–ª—É</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É¬ª</strong></li>
            <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
          </ol>
        </div>
        
        <div class="space-y-2">
          <h4 class="font-medium text-slate-100">–î–ª—è Android (Chrome):</h4>
          <ol class="list-decimal list-inside space-y-1">
            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∑–∞–º–∫–∞ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–∞¬ª</strong></li>
            <li>–ù–∞–π–¥–∏—Ç–µ <strong>¬´–ú–∏–∫—Ä–æ—Ñ–æ–Ω¬ª</strong> –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–†–∞–∑—Ä–µ—à–∏—Ç—å¬ª</strong></li>
            <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
          </ol>
        </div>
        
        <div class="space-y-2">
          <h4 class="font-medium text-slate-100">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:</h4>
          <ol class="list-decimal list-inside space-y-1">
            <li>–ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞</li>
            <li>–ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª <strong>¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–æ–≤¬ª</strong> –∏–ª–∏ <strong>¬´–†–∞–∑—Ä–µ—à–µ–Ω–∏—è¬ª</strong></li>
            <li>–ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ—Ç —Å–∞–π—Ç –≤ —Å–ø–∏—Å–∫–µ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</li>
            <li>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –µ—ë</li>
          </ol>
        </div>
      </div>
      
      <div class="flex justify-end mt-6">
        <button id="refreshPage" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium transition">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveLog = document.getElementById('saveLog');
    const callStatus = document.getElementById('callStatus');
    const connectionQuality = document.getElementById('connectionQuality');
    const callTimer = document.getElementById('callTimer');

    const localVideo = document.getElementById('localVideo');
    const localVideoContainer = document.getElementById('localVideoContainer');
    const remoteVideo = document.getElementById('remoteVideo');
    const waitingOverlay = document.getElementById('waitingOverlay');

    const createOfferBtn = document.getElementById('createOfferBtn');
    const connectBtn = document.getElementById('connectBtn');
    const resetCall = document.getElementById('resetCall');
    const inviteOut = document.getElementById('inviteOut');
    const inviteIn = document.getElementById('inviteIn');
    const copyInvite = document.getElementById('copyInvite');

    const toggleMic = document.getElementById('toggleMic');
    const toggleCam = document.getElementById('toggleCam');
    const shareScreen = document.getElementById('shareScreen');
    const fullscreenMain = document.getElementById('fullscreenMain');
    const snapBtn = document.getElementById('snapBtn');
    const recordBtn = document.getElementById('recordBtn');
    const liveBadge = document.getElementById('liveBadge');
    const levelEl = document.getElementById('level');

    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    const emojiBtn = document.getElementById('emojiBtn');
    const replyBadge = document.getElementById('replyBadge');
    const replyText = document.getElementById('replyText');
    const cancelReply = document.getElementById('cancelReply');

    const drawModal = document.getElementById('drawModal');
    const drawCanvas = document.getElementById('drawCanvas');
    const brushColor = document.getElementById('brushColor');
    const brushSize = document.getElementById('brushSize');
    const clearCanvasBtn = document.getElementById('clearCanvas');
    const closeDraw = document.getElementById('closeDraw');
    const sendDrawing = document.getElementById('sendDrawing');

    const viewer = document.getElementById('viewer');
    const viewerClose = document.getElementById('viewerClose');
    const viewerBody = document.getElementById('viewerBody');

    const tooltip = document.getElementById('tooltip');

    // State
    let pc = null;
    let localStream = null;
    let screenStream = null;
    let micEnabled = true;
    let camEnabled = true;
    let isConnected = false;
    let callStartTime = null;
    let timerInterval = null;
    let statsInterval = null;
    let recorder = null;
    let recordedChunks = [];
    let hasMediaDevices = false;

    let fallbackAudioTrack = null;
    let fallbackVideoTrack = null;

    let dataChannel = null;
    let replyTarget = null;
    const messageMap = new Map();

    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    function createSilentAudioTrack() {
      // Fallback for mobile browsers that may block audio context without user interaction
      try {
        const ctx = new AudioContext();
        const oscillator = ctx.createOscillator();
        const dst = ctx.createMediaStreamDestination();
        oscillator.connect(dst);
        oscillator.start();
        const track = dst.stream.getAudioTracks()[0];
        track.enabled = false;
        return track;
      } catch (err) {
        console.warn('AudioContext failed, using dummy track:', err);
        // Create a dummy track for mobile compatibility
        const stream = new MediaStream();
        const track = stream.addTrack(Object.assign(
          new MediaStreamTrack(), {
            kind: 'audio',
            enabled: false,
            stop: () => {}
          }
        ));
        return track;
      }
    }
    function createBlackVideoTrack() {
      const canvas = document.createElement('canvas');
      canvas.width = 640; canvas.height = 360;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      const stream = canvas.captureStream(5);
      const track = stream.getVideoTracks()[0];
      track.enabled = false;
      return track;
    }
    function ensureFallbackTracks() {
      if (!fallbackAudioTrack) fallbackAudioTrack = createSilentAudioTrack();
      if (!fallbackVideoTrack) fallbackVideoTrack = createBlackVideoTrack();
    }
    function ensureSenders(peer) {
      ensureFallbackTracks();
      const existingSenders = peer.getSenders();
      let audioSender = existingSenders.find(s => s.track && s.track.kind === 'audio');
      let videoSender = existingSenders.find(s => s.track && s.track.kind === 'video');
      if (!audioSender) audioSender = peer.addTrack(fallbackAudioTrack, new MediaStream([fallbackAudioTrack]));
      if (!videoSender) videoSender = peer.addTrack(fallbackVideoTrack, new MediaStream([fallbackVideoTrack]));
      return { audioSender, videoSender };
    }
    function bindLocalTracks(stream) {
      if (!pc || !stream) return;
      const { audioSender, videoSender } = ensureSenders(pc);
      const audioTrack = stream.getAudioTracks()[0];
      const videoTrack = stream.getVideoTracks()[0];
      if (audioTrack) { audioSender.replaceTrack(audioTrack); audioTrack.enabled = micEnabled; }
      if (videoTrack) { videoSender.replaceTrack(videoTrack); videoTrack.enabled = camEnabled; }
    }

    function setStatus(text, tone = 'neutral') {
      const tones = {
        neutral: 'bg-white/10 border-white/10 text-slate-200',
        info: 'bg-indigo-500/20 border-indigo-400/50 text-indigo-100',
        success: 'bg-emerald-500/20 border-emerald-400/50 text-emerald-100',
        error: 'bg-rose-500/20 border-rose-400/60 text-rose-100'
      };
      callStatus.textContent = text;
      callStatus.className = `px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs ${tones[tone] || tones.neutral}`;
    }

    const makeId = () => 'm-' + Math.random().toString(36).slice(2,9) + Date.now().toString(36);

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      requestAnimationFrame(() => {
        notification.classList.add('show');
      });
      setTimeout(() => {
        notification.classList.add('hide');
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    function deleteMessage(id) {
      const entry = messageMap.get(id);
      if (!entry) return;
      entry.el.classList.add('msg-deleting');
      setTimeout(() => {
        entry.el.remove();
        messageMap.delete(id);
      }, 300);
      // Notify remote about deletion
      if (dataChannel?.readyState === 'open') {
        dataChannel.send(JSON.stringify({ type: 'delete', id }));
      }
    }

    function addMessage(user, text, type = 'text', extra = {}, opts = {}) {
      const id = opts.id || makeId();
      const wrap = document.createElement('div');
      wrap.className = 'chat-card p-2 rounded-lg bg-white/5 border border-white/5 space-y-1.5 relative';
      wrap.dataset.id = id;

      const isMe = user === '–í—ã';
      const color = isMe ? 'from-indigo-500 to-fuchsia-500' : 'from-emerald-500 to-cyan-500';
      const initial = user.slice(0,1);

      const header = document.createElement('div');
      header.className = 'flex items-center gap-2';
      header.innerHTML = `<div class="h-5 w-5 md:h-6 md:w-6 rounded-full bg-gradient-to-br ${color} flex items-center justify-center text-[9px] md:text-[10px] font-semibold">${initial}</div><span class="font-medium text-xs md:text-sm">${user}</span>`;
      wrap.appendChild(header);

      if (opts.replyPreview) {
        const reply = document.createElement('div');
        reply.className = 'text-[10px] md:text-[11px] text-slate-400 bg-white/5 border border-white/10 rounded px-2 py-1 ml-6 md:ml-8 truncate';
        reply.textContent = '–û—Ç–≤–µ—Ç: ' + opts.replyPreview;
        wrap.appendChild(reply);
      }

      const body = document.createElement('div');
      body.className = 'pl-6 md:pl-8 space-y-1.5';

      if (type === 'text') {
        const p = document.createElement('p');
        p.className = 'text-xs md:text-sm text-slate-200 whitespace-pre-wrap break-words';
        p.textContent = text;
        body.appendChild(p);
      } else if (type === 'file') {
        const box = document.createElement('div');
        box.className = 'flex items-center gap-2 text-xs md:text-sm text-slate-200 flex-wrap';
        box.innerHTML = `üìÑ <span class="break-all">${extra.name || '—Ñ–∞–π–ª'}</span> <span class="text-slate-500 text-[10px] md:text-xs">${extra.size || ''}</span>`;
        const dl = document.createElement('a');
        dl.href = extra.url; dl.download = extra.name || 'file'; dl.target = '_blank';
        dl.className = 'ml-auto px-2 py-0.5 text-[10px] md:text-xs rounded bg-white/10 border border-white/10 hover:bg-white/20';
        dl.textContent = '‚¨á';
        box.appendChild(dl);
        body.appendChild(box);
      } else if (type === 'image') {
        const fig = document.createElement('div');
        fig.className = 'relative group';
        const img = document.createElement('img');
        img.src = extra.url; img.alt = extra.name || 'image';
        img.className = 'max-h-32 md:max-h-48 rounded-lg border border-white/10 cursor-zoom-in';
        img.dataset.full = extra.url;
        fig.appendChild(img);
        const dl = document.createElement('a');
        dl.href = extra.url; dl.download = extra.name || 'image'; 
        dl.className = 'absolute top-1 right-1 md:top-2 md:right-2 px-1.5 py-0.5 md:px-2 md:py-1 text-[10px] md:text-xs rounded bg-black/60 border border-white/20 opacity-0 group-hover:opacity-100 transition';
        dl.textContent = '‚¨á';
        fig.appendChild(dl);
        body.appendChild(fig);
      } else if (type === 'video') {
        const box = document.createElement('div');
        box.className = 'relative group';
        const vid = document.createElement('video');
        vid.src = extra.url; vid.controls = true; vid.className = 'rounded-lg border border-white/10 max-h-40 md:max-h-64 w-full';
        box.appendChild(vid);
        const dl = document.createElement('a');
        dl.href = extra.url; dl.download = extra.name || 'video'; 
        dl.className = 'absolute top-1 right-1 md:top-2 md:right-2 px-1.5 py-0.5 md:px-2 md:py-1 text-[10px] md:text-xs rounded bg-black/60 border border-white/20 opacity-0 group-hover:opacity-100 transition';
        dl.textContent = '‚¨á';
        box.appendChild(dl);
        body.appendChild(box);
      }

      wrap.appendChild(body);

      const actions = document.createElement('div');
      actions.className = 'msg-actions flex gap-1.5 md:gap-2 text-[10px] md:text-xs text-slate-400 pl-6 md:pl-8';
      
      const replyBtn = document.createElement('button');
      replyBtn.className = 'px-1.5 py-0.5 md:px-2 md:py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10';
      replyBtn.textContent = '‚Ü©';
      replyBtn.title = '–û—Ç–≤–µ—Ç–∏—Ç—å';
      replyBtn.onclick = () => setReply({ id, preview: (text || extra.name || '').slice(0,60) });
      
      const reactBtn = document.createElement('button');
      reactBtn.className = 'px-1.5 py-0.5 md:px-2 md:py-1 rounded bg-white/5 border border-white/10 hover:bg-white/10';
      reactBtn.textContent = 'üòä';
      reactBtn.title = '–†–µ–∞–∫—Ü–∏—è';
      reactBtn.onclick = () => openReactionMenu(id, reactBtn);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'px-1.5 py-0.5 md:px-2 md:py-1 rounded bg-white/5 border border-white/10 hover:bg-rose-500/30 text-rose-300';
      deleteBtn.textContent = 'üóë';
      deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.onclick = () => deleteMessage(id);
      
      actions.append(replyBtn, reactBtn, deleteBtn);
      wrap.appendChild(actions);

      const reactRow = document.createElement('div');
      reactRow.className = 'flex gap-1 pl-6 md:pl-8 pt-1 flex-wrap text-sm md:text-lg';
      wrap.appendChild(reactRow);

      chat.appendChild(wrap);
      chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });

      messageMap.set(id, { el: wrap, reactions: reactRow });
      return id;
    }

    function applyReaction(targetId, emoji) {
      const entry = messageMap.get(targetId);
      if (!entry) return;
      const span = document.createElement('span');
      span.textContent = emoji;
      span.className = 'bg-white/10 rounded px-1.5 py-0.5';
      entry.reactions.appendChild(span);
    }

    function openReactionMenu(id, anchor) {
      const emojis = ['üëç','‚ù§Ô∏è','üòÇ','üî•','üëè','üòÆ'];
      const menu = document.createElement('div');
      menu.className = 'absolute z-30 bg-slate-900 border border-white/10 rounded-lg px-2 py-1 flex gap-1 shadow-xl';
      emojis.forEach(e => {
        const b = document.createElement('button');
        b.textContent = e; b.className = 'hover:scale-110 transition text-base md:text-lg';
        b.onclick = (ev) => {
          ev.stopPropagation();
          applyReaction(id, e);
          if (dataChannel?.readyState === 'open') dataChannel.send(JSON.stringify({ type: 'reaction', id, emoji: e }));
          menu.remove();
        };
        menu.appendChild(b);
      });
      document.body.appendChild(menu);
      const rect = anchor.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.top = Math.min(rect.bottom + 6, window.innerHeight - 50) + 'px';
      menu.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - 200)) + 'px';
      const remover = () => menu.remove();
      setTimeout(() => document.addEventListener('click', remover, { once: true }), 0);
    }

    function setReply(target) {
      replyTarget = target;
      replyBadge.classList.remove('hidden');
      replyBadge.classList.add('flex');
      replyText.textContent = target.preview;
    }
    cancelReply.addEventListener('click', () => { replyTarget = null; replyBadge.classList.add('hidden'); });

    function sendMessage(text) {
      const msg = text !== undefined ? text : messageInput.value.trim();
      if (!msg) return;
      const id = makeId();
      addMessage('–í—ã', msg, 'text', {}, { id, replyPreview: replyTarget?.preview });
      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(JSON.stringify({ type: 'chat', text: msg, id, replyPreview: replyTarget?.preview }));
      }
      messageInput.value = '';
      replyTarget = null; replyBadge.classList.add('hidden');
    }

    sendBtn.addEventListener('click', () => sendMessage());
    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    clearBtn.addEventListener('click', () => { chat.innerHTML = ''; messageMap.clear(); });
    saveLog.addEventListener('click', () => {
      const blob = new Blob([chat.innerText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'chat-log.txt'; a.click(); URL.revokeObjectURL(url);
    });

    function openEmojiPicker(anchor) {
      const emojis = 'üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòå üòç ü•∞ üòò üòó üòô üòö üòã üòõ üòú ü§™ üòù ü§ë ü§ó ü§≠ ü§´ ü§î ü§ê ü§® üòê üòë üò∂ üòè üòí üôÑ üò¨ ü§• üòå üòî üò™ ü§§ üò¥ üò∑ ü§í ü§ï ü§¢ ü§Æ ü§ß ü•µ ü•∂ ü•¥ üòµ ü§Ø ü§† ü•≥ üòé ü§ì üßê üòï üòü üôÅ ‚òπÔ∏è üòÆ üòØ üò≤ üò≥ ü•∫ üò¶ üòß üò® üò∞ üò• üò¢ üò≠ üò± üòñ üò£ üòû üòì üò© üò´ ü•± üò§ üò° üò† ü§¨ üòà üëø üíÄ ‚ò†Ô∏è üí© ü§° üëπ üë∫ üëª üëΩ ü§ñ üéÉ üëç üëé üëä ‚úä ü§õ ü§ú ü§û ‚úåÔ∏è ü§ü ü§ò ü§ô üëã üñêÔ∏è ‚úã üëå üôè üí™ ‚ù§Ô∏è üß° üíõ üíö üíô üíú üñ§ ü§ç üíî üíï üíû üíì üíó üíñ üíò üíù'.split(/\s+/);
      const menu = document.createElement('div');
      menu.className = 'fixed z-30 max-w-[280px] md:max-w-xs bg-slate-900 border border-white/10 rounded-xl p-2 shadow-2xl grid grid-cols-8 gap-1 text-base md:text-lg max-h-[50vh] overflow-y-auto';

      emojis.forEach(e => {
        if (!e) return;
        const b = document.createElement('button');
        b.textContent = e;
        b.className = 'hover:scale-110 transition leading-none p-0.5';
        b.onclick = (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          const start = messageInput.selectionStart || messageInput.value.length;
          const end = messageInput.selectionEnd || messageInput.value.length;
          const value = messageInput.value;
          messageInput.value = value.slice(0, start) + e + value.slice(end);
          const caret = start + e.length;
          messageInput.focus();
          messageInput.setSelectionRange(caret, caret);
          menu.remove();
        };
        menu.appendChild(b);
      });

      document.body.appendChild(menu);
      const rect = anchor.getBoundingClientRect();
      const mw = menu.offsetWidth;
      const mh = menu.offsetHeight;
      menu.style.top = Math.max(8, rect.top - mh - 8) + 'px';
      menu.style.left = Math.max(8, Math.min(rect.left + rect.width / 2 - mw / 2, window.innerWidth - mw - 8)) + 'px';

      const close = (ev) => {
        if (!menu.contains(ev.target)) {
          menu.remove();
          document.removeEventListener('click', close);
        }
      };
      setTimeout(() => document.addEventListener('click', close), 0);
    }

    emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      openEmojiPicker(emojiBtn);
    });

    attachBtn.addEventListener('click', () => fileInput.click());

    let drawingImage = null;
    const ctxDraw = drawCanvas.getContext('2d');
    let drawing = false;
    let imgForDraw = new Image();

    function resizeCanvasToImage(img) {
      // Wait for modal to be visible to get correct dimensions
      requestAnimationFrame(() => {
        const container = drawCanvas.parentElement;
        const containerWidth = container.clientWidth || window.innerWidth - 48;
        const maxW = Math.min(1200, containerWidth - 48);
        const maxH = Math.min(600, window.innerHeight * 0.6);
        let { width, height } = img;
        
        // Ensure minimum size
        if (width < 100) width = 100;
        if (height < 100) height = 100;
        
        const scale = Math.min(1, maxW / width, maxH / height);
        width = Math.floor(width * scale); 
        height = Math.floor(height * scale);
        
        // Set minimum dimensions
        width = Math.max(300, width);
        height = Math.max(200, height);
        
        drawCanvas.width = width; 
        drawCanvas.height = height;
        ctxDraw.fillStyle = '#1e293b';
        ctxDraw.fillRect(0, 0, width, height);
        
        // Center the image on canvas
        const imgScale = Math.min(width / img.width, height / img.height);
        const imgW = img.width * imgScale;
        const imgH = img.height * imgScale;
        const offsetX = (width - imgW) / 2;
        const offsetY = (height - imgH) / 2;
        
        ctxDraw.drawImage(img, offsetX, offsetY, imgW, imgH);
      });
    }

    function openDrawModal(file) {
      drawModal.classList.remove('hidden'); 
      drawModal.classList.add('flex');
      
      const reader = new FileReader();
      reader.onload = e => { 
        imgForDraw = new Image();
        imgForDraw.onload = () => { 
          resizeCanvasToImage(imgForDraw); 
        }; 
        imgForDraw.src = e.target.result; 
      };
      reader.readAsDataURL(file);
      drawingImage = file;
    }
    
    function closeDrawModal() {
      drawModal.classList.add('hidden'); 
      drawModal.classList.remove('flex');
    }

    function getDrawPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const scaleX = drawCanvas.width / rect.width;
      const scaleY = drawCanvas.height / rect.height;
      if (e.touches) {
        return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
      }
      return { x: e.offsetX * scaleX, y: e.offsetY * scaleY };
    }

    drawCanvas.addEventListener('mousedown', e => { drawing = true; ctxDraw.strokeStyle = brushColor.value; ctxDraw.lineWidth = brushSize.value; ctxDraw.lineCap = 'round'; ctxDraw.lineJoin = 'round'; ctxDraw.beginPath(); const pos = getDrawPos(e); ctxDraw.moveTo(pos.x, pos.y); });
    drawCanvas.addEventListener('mousemove', e => { if (!drawing) return; const pos = getDrawPos(e); ctxDraw.lineTo(pos.x, pos.y); ctxDraw.stroke(); });
    drawCanvas.addEventListener('mouseup', () => drawing = false);
    drawCanvas.addEventListener('mouseleave', () => drawing = false);
    
    // Touch support
    drawCanvas.addEventListener('touchstart', e => { e.preventDefault(); drawing = true; ctxDraw.strokeStyle = brushColor.value; ctxDraw.lineWidth = brushSize.value; ctxDraw.lineCap = 'round'; ctxDraw.lineJoin = 'round'; ctxDraw.beginPath(); const pos = getDrawPos(e); ctxDraw.moveTo(pos.x, pos.y); }, { passive: false });
    drawCanvas.addEventListener('touchmove', e => { e.preventDefault(); if (!drawing) return; const pos = getDrawPos(e); ctxDraw.lineTo(pos.x, pos.y); ctxDraw.stroke(); }, { passive: false });
    drawCanvas.addEventListener('touchend', () => drawing = false);
    
    clearCanvasBtn.addEventListener('click', () => { 
      // Redraw the original image
      ctxDraw.fillStyle = '#1e293b';
      ctxDraw.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
      const imgScale = Math.min(drawCanvas.width / imgForDraw.width, drawCanvas.height / imgForDraw.height);
      const imgW = imgForDraw.width * imgScale;
      const imgH = imgForDraw.height * imgScale;
      const offsetX = (drawCanvas.width - imgW) / 2;
      const offsetY = (drawCanvas.height - imgH) / 2;
      ctxDraw.drawImage(imgForDraw, offsetX, offsetY, imgW, imgH);
    });
    closeDraw.addEventListener('click', closeDrawModal);
    
    // Add cancelDraw button handler
    const cancelDrawBtn = document.getElementById('cancelDraw');
    if (cancelDrawBtn) {
      cancelDrawBtn.addEventListener('click', closeDrawModal);
    }

    sendDrawing.addEventListener('click', () => {
      drawCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const id = makeId();
        addMessage('–í—ã', '', 'image', { url, name: 'image.png' }, { id });
        if (dataChannel?.readyState === 'open') {
          sendFile(blob, 'image.png', 'image/png', id);
        }
        drawModal.classList.add('hidden');
        drawModal.classList.remove('flex');
      }, 'image/png');
    });

    async function sendFile(blob, name, mimeType, msgId) {
      try {
        const buf = await blob.arrayBuffer();
        dataChannel.send(JSON.stringify({ type: 'file-meta', name, kind: mimeType, size: blob.size, id: msgId }));
        await new Promise(r => setTimeout(r, 50));
        await sendFileData(buf);
      } catch (err) {
        console.error('Error sending file:', err);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
      }
    }

    async function sendFileData(buffer) {
      return new Promise((resolve, reject) => {
        const chunkSize = 16384;
        let offset = 0;
        
        function sendChunk() {
          if (offset >= buffer.byteLength) {
            resolve();
            return;
          }
          if (!dataChannel || dataChannel.readyState !== 'open') {
            reject(new Error('DataChannel closed'));
            return;
          }
          const chunk = buffer.slice(offset, Math.min(offset + chunkSize, buffer.byteLength));
          offset += chunkSize;
          try {
            dataChannel.send(chunk);
            if (dataChannel.bufferedAmount > 1048576) {
              const checkBuffer = setInterval(() => {
                if (!dataChannel || dataChannel.readyState !== 'open') {
                  clearInterval(checkBuffer);
                  reject(new Error('DataChannel closed during send'));
                  return;
                }
                if (dataChannel.bufferedAmount < 524288) {
                  clearInterval(checkBuffer);
                  setTimeout(sendChunk, 10);
                }
              }, 50);
            } else {
              setTimeout(sendChunk, 5);
            }
          } catch (err) {
            reject(err);
          }
        }
        sendChunk();
      });
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const id = makeId();
      if (file.type.startsWith('image/')) {
        openDrawModal(file); 
        fileInput.value = '';
        return;
      }
      const type = file.type.startsWith('video/') ? 'video' : 'file';
      addMessage('–í—ã', file.name, type, { url, name: file.name, size: `${(file.size/1024).toFixed(1)} KB` }, { id });
      if (dataChannel?.readyState === 'open') {
        await sendFile(file, file.name, file.type, id);
      }
      fileInput.value = '';
    });

    let incomingFileMeta = null;
    let incomingBuffer = [];
    
    function handleBinary(data) {
      if (!incomingFileMeta) {
        console.warn('Received binary without meta');
        return;
      }
      incomingBuffer.push(data);
      const received = incomingBuffer.reduce((sum, buf) => sum + buf.byteLength, 0);
      if (received >= incomingFileMeta.size) {
        try {
          const blob = new Blob(incomingBuffer, { type: incomingFileMeta.kind || 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          const base = { url, name: incomingFileMeta.name, size: `${(blob.size/1024).toFixed(1)} KB` };
          let msgType = 'file';
          if (incomingFileMeta.kind?.startsWith('image/')) msgType = 'image';
          else if (incomingFileMeta.kind?.startsWith('video/')) msgType = 'video';
          addMessage('–î—Ä—É–≥', incomingFileMeta.name || '', msgType, base, { id: incomingFileMeta.id });
        } catch (err) {
          console.error('Error processing file:', err);
        } finally {
          incomingFileMeta = null;
          incomingBuffer = [];
        }
      }
    }

    async function startCamera() {
      try {
        // Mobile-optimized constraints
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user', // Prefer front camera on mobile
            frameRate: { ideal: 24, max: 30 }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            channelCount: 1, // Mono audio for better compatibility
            sampleRate: { ideal: 44100, min: 16000 },
            sampleSize: 16
          }
        };

        // Try to get both video and audio
        try {
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          
          // Check if we actually got audio tracks
          const audioTracks = localStream.getAudioTracks();
          if (audioTracks.length === 0) {
            console.warn('No audio tracks received, adding fallback');
            ensureFallbackTracks();
            localStream.addTrack(fallbackAudioTrack);
          }
        } catch (err) {
          console.warn('Full media access failed, trying video-only:', err);
          // Fallback to video-only if audio fails
          localStream = await navigator.mediaDevices.getUserMedia({ video: constraints.video });
          ensureFallbackTracks();
          localStream.addTrack(fallbackAudioTrack);
        }

        localVideo.srcObject = localStream;
        localVideo.classList.remove('hidden');
        localVideoContainer.classList.add('hidden');
        await localVideo.play();
        initAudioMeter(localStream);
        hasMediaDevices = true;
        updateMediaButtons();
        bindLocalTracks(localStream);
        
        // Show warning if using fallback audio
        if (localStream.getAudioTracks().some(t => t === fallbackAudioTrack)) {
          showNotification('‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞');
        } else {
          showNotification('‚úÖ –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
        }
        
        return true;
      } catch (err) {
        console.error('Camera error:', err);
        hasMediaDevices = false;
        updateMediaButtons();
        showNotification('‚ö†Ô∏è –ú–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        return false;
      }
    }

    function updateMediaButtons() {
      toggleMic.disabled = !hasMediaDevices;
      toggleCam.disabled = !hasMediaDevices;
      if (hasMediaDevices) {
        toggleMic.innerHTML = micEnabled ? '<span class="control-btn-icon">üé§</span><span class="control-btn-text"> –ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>' : '<span class="control-btn-icon">üîá</span><span class="control-btn-text"> –ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>';
        toggleCam.innerHTML = camEnabled ? '<span class="control-btn-icon">üì∑</span><span class="control-btn-text"> –ö–∞–º–µ—Ä–∞</span>' : '<span class="control-btn-icon">üì∑‚ùå</span><span class="control-btn-text"> –ö–∞–º–µ—Ä–∞</span>';
      } else {
        toggleMic.innerHTML = '<span class="control-btn-icon">üé§‚ùå</span>';
        toggleCam.innerHTML = '<span class="control-btn-icon">üì∑‚ùå</span>';
      }
    }

    toggleMic.addEventListener('click', () => {
      if (!hasMediaDevices) {
        showMicInstruction();
        return;
      }
      if (!localStream) {
        showNotification('‚ö†Ô∏è –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        return;
      }
      
      // Check if we're using fallback audio
      const usingFallback = localStream.getAudioTracks().some(t => t === fallbackAudioTrack);
      if (usingFallback) {
        showMicInstruction();
        return;
      }
      
      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
      updateMediaButtons();
      toggleMic.classList.toggle('bg-rose-600/50', !micEnabled);
    });
    toggleCam.addEventListener('click', () => { if (!localStream || !hasMediaDevices) return; camEnabled = !camEnabled; localStream.getVideoTracks().forEach(t => t.enabled = camEnabled); updateMediaButtons(); toggleCam.classList.toggle('bg-rose-600/50', !camEnabled); });

    shareScreen.addEventListener('click', async () => {
      if (screenStream) {
        screenStream.getTracks().forEach(t => t.stop()); 
        screenStream = null;
        if (pc) { 
          const { videoSender } = ensureSenders(pc); 
          const camTrack = (localStream && localStream.getVideoTracks().length > 0) ? localStream.getVideoTracks()[0] : fallbackVideoTrack; 
          await videoSender.replaceTrack(camTrack); 
        }
        localVideo.srcObject = localStream || new MediaStream([fallbackVideoTrack]);
        shareScreen.innerHTML = '<span class="control-btn-icon">üñ•Ô∏è</span><span class="control-btn-text"> –≠–∫—Ä–∞–Ω</span>'; 
        shareScreen.classList.remove('bg-indigo-600/50'); 
        addMessage('–í—ã', '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
      } else {
        try {
          screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always' }, audio: true });
          if (pc) { 
            const { videoSender, audioSender } = ensureSenders(pc); 
            const videoTrack = screenStream.getVideoTracks()[0]; 
            const audioTrack = screenStream.getAudioTracks()[0]; 
            if (videoSender && videoTrack) await videoSender.replaceTrack(videoTrack); 
            if (audioSender && audioTrack) await audioSender.replaceTrack(audioTrack); 
          }
          localVideo.srcObject = screenStream; 
          localVideo.classList.remove('hidden'); 
          localVideoContainer.classList.add('hidden');
          shareScreen.innerHTML = '<span class="control-btn-icon">üñ•Ô∏è</span><span class="control-btn-text"> –°—Ç–æ–ø</span>'; 
          shareScreen.classList.add('bg-indigo-600/50'); 
          addMessage('–í—ã', '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å');
          
          screenStream.getVideoTracks()[0].onended = () => {
            if (screenStream) shareScreen.click();
          };
        } catch (err) { 
          console.error('Screen share error:', err); 
          showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é'); 
        }
      }
    });

    fullscreenMain.addEventListener('click', () => { const container = remoteVideo.parentElement; if (!document.fullscreenElement) container.requestFullscreen?.(); else document.exitFullscreen?.(); });
    localVideo.addEventListener('click', () => { const mainSrc = remoteVideo.srcObject; const pipSrc = localVideo.srcObject; remoteVideo.srcObject = pipSrc; localVideo.srcObject = mainSrc; });

    snapBtn.addEventListener('click', () => {
      const stream = remoteVideo.srcObject || localVideo.srcObject; if (!stream) return;
      const videoTrack = stream.getVideoTracks()[0]; if (!videoTrack) return;
      const imageCapture = new ImageCapture(videoTrack);
      imageCapture.grabFrame().then(bitmap => { 
        const canvas = document.createElement('canvas'); 
        canvas.width = bitmap.width; canvas.height = bitmap.height; 
        const ctx = canvas.getContext('2d'); ctx.drawImage(bitmap, 0, 0); 
        canvas.toBlob(blob => { 
          const url = URL.createObjectURL(blob); const a = document.createElement('a'); 
          a.href = url; a.download = 'snapshot.png'; a.click(); URL.revokeObjectURL(url); 
          showNotification('üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); 
        }); 
      }).catch(() => showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç')); 
    });

    recordBtn.addEventListener('click', () => {
      const stream = remoteVideo.srcObject || localVideo.srcObject; if (!stream) return showNotification('‚ö†Ô∏è –ù–µ—Ç –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞');
      if (recorder && recorder.state === 'recording') { 
        recorder.stop(); 
        recordBtn.innerHTML = '<span class="control-btn-icon">‚è∫Ô∏è</span><span class="control-btn-text"> –ó–∞–ø–∏—Å—å</span>'; 
        recordBtn.classList.remove('bg-rose-600/60'); 
        liveBadge.textContent = 'LIVE'; showNotification('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); 
      }
      else { 
        recordedChunks = []; recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9,opus' }); 
        recorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); }; 
        recorder.onstop = () => { 
          const blob = new Blob(recordedChunks, { type: 'video/webm' }); 
          const url = URL.createObjectURL(blob); 
          const a = document.createElement('a'); a.href = url; a.download = 'recording.webm'; a.click(); URL.revokeObjectURL(url); 
        }; 
        recorder.start(); 
        recordBtn.innerHTML = '<span class="control-btn-icon">‚ñ†</span><span class="control-btn-text"> –°—Ç–æ–ø</span>'; 
        recordBtn.classList.add('bg-rose-600/60'); 
        liveBadge.textContent = 'REC'; showNotification('‚è∫Ô∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å'); 
      }
    });

    function buildShortCode(desc) {
      const data = { t: desc.type === 'offer' ? 'o' : 'a', s: desc.sdp }; 
      const compressed = pako.deflate(JSON.stringify(data), { level: 9 }); 
      let binary = ''; 
      for (let i = 0; i < compressed.byteLength; i++) binary += String.fromCharCode(compressed[i]); 
      return btoa(binary).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
    }
    function parseShortCode(str) {
      try { 
        const code = str.trim().replace(/-/g,'+').replace(/_/g,'/'); 
        const padded = code + '='.repeat((4 - code.length % 4) % 4); 
        const binary = atob(padded); 
        const bytes = new Uint8Array(binary.length); 
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i); 
        const decompressed = pako.inflate(bytes, { to: 'string' }); 
        const data = JSON.parse(decompressed); 
        return new RTCSessionDescription({ type: data.t === 'o' ? 'offer' : 'answer', sdp: data.s }); 
      } catch (err) { 
        console.error('Parse error:', err); 
        setStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 'error'); 
        return null; 
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(rtcConfig);
      ensureSenders(pc);
      dataChannel = pc.createDataChannel('chat');
      setupDataChannel(dataChannel);
      pc.ondatachannel = (event) => { dataChannel = event.channel; setupDataChannel(dataChannel); };
      pc.ontrack = (event) => { 
        if (event.streams[0]) { 
          remoteVideo.srcObject = event.streams[0]; remoteVideo.play().catch(e => console.error('Play error:', e)); 
          waitingOverlay.style.display = 'none'; isConnected = true; setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'success'); 
          showNotification('‚úÖ –î—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!'); startTimer(); startStats(); 
        } 
      };
      pc.onconnectionstatechange = () => { 
        if (!pc) return; 
        if (pc.connectionState === 'connected') { 
          setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'success'); waitingOverlay.style.display = 'none'; 
          isConnected = true; startTimer(); startStats(); 
        } else if (pc.connectionState === 'connecting') { 
          setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info'); 
        } else if (['failed', 'disconnected', 'closed'].includes(pc.connectionState)) { 
          setStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'error'); waitingOverlay.style.display = 'flex'; 
          isConnected = false; stopTimer(); stopStats(); 
        } 
      };
      return pc;
    }

    function setupDataChannel(channel) {
      channel.binaryType = 'arraybuffer';
      channel.onmessage = (event) => {
        const payload = event.data;
        if (typeof payload === 'string') {
          try {
            const data = JSON.parse(payload);
            if (data.type === 'chat') {
              addMessage('–î—Ä—É–≥', data.text, 'text', {}, { id: data.id || makeId(), replyPreview: data.replyPreview || null });
            } else if (data.type === 'file-meta') {
              incomingFileMeta = data; incomingBuffer = [];
            } else if (data.type === 'reaction') {
              applyReaction(data.id, data.emoji);
            } else if (data.type === 'delete') {
              // Remote deletion
              const entry = messageMap.get(data.id);
              if (entry) {
                entry.el.classList.add('msg-deleting');
                setTimeout(() => {
                  entry.el.remove();
                  messageMap.delete(data.id);
                }, 300);
              }
            }
          } catch (e) { console.warn('Bad JSON from dataChannel', e); }
        } else if (payload instanceof ArrayBuffer) {
          handleBinary(payload);
        }
      };
      channel.onopen = () => console.log('Data channel open');
      channel.onclose = () => console.log('Data channel closed');
    }

    function resetPeer() {
      if (pc) { try { pc.close(); } catch (e) {} }
      pc = null; dataChannel = null; remoteVideo.srcObject = null;
      waitingOverlay.style.display = 'flex'; isConnected = false; stopTimer(); stopStats(); 
      setStatus('–û–∂–∏–¥–∞–Ω–∏–µ'); inviteOut.value = ''; inviteIn.value = '';
      incomingFileMeta = null; incomingBuffer = [];
    }
    resetCall.addEventListener('click', resetPeer);

    async function createInvite() {
      try {
        setStatus('–°–æ–∑–¥–∞–Ω–∏–µ...', 'info'); resetPeer();
        // Auto-enable media
        if (!localStream) { await startCamera(); }
        const peer = createPeerConnection(); 
        if (localStream) bindLocalTracks(localStream); 
        else ensureSenders(peer);
        const offer = await peer.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }); 
        await peer.setLocalDescription(offer);
        await new Promise(r => setTimeout(r, 1200)); 
        inviteOut.value = buildShortCode(peer.localDescription); 
        setStatus('–ö–æ–¥ –≥–æ—Ç–æ–≤', 'success'); showNotification('üì§ –ö–æ–¥ —Å–æ–∑–¥–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É');
      } catch (err) { setStatus('–û—à–∏–±–∫–∞', 'error'); showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message); }
    }

    async function connect() {
      const code = inviteIn.value.trim(); if (!code) { setStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥', 'error'); return; }
      const remoteDesc = parseShortCode(code); if (!remoteDesc) return;
      try {
        setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info'); 
        // Auto-enable media
        if (!localStream) { await startCamera(); }
        if (!pc) { 
          const peer = createPeerConnection(); 
          if (localStream) bindLocalTracks(localStream); 
          else ensureSenders(peer); 
        }
        await pc.setRemoteDescription(remoteDesc);
        if (remoteDesc.type === 'offer') {
          const answer = await pc.createAnswer({ offerToReceiveAudio: true, offerToReceiveVideo: true }); await pc.setLocalDescription(answer);
          await new Promise(r => setTimeout(r, 1200)); inviteOut.value = buildShortCode(pc.localDescription); 
          setStatus('–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞', 'info'); showNotification('üì§ –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –≥–æ—Ç–æ–≤!');
        }
      } catch (err) { setStatus('–û—à–∏–±–∫–∞', 'error'); showNotification('‚ùå –û—à–∏–±–∫–∞: ' + err.message); }
    }

    async function copyToClipboard() { if (!inviteOut.value) return; try { await navigator.clipboard.writeText(inviteOut.value); setStatus('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success'); showNotification('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); } catch (err) { setStatus('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error'); } }
    createOfferBtn.addEventListener('click', createInvite);
    connectBtn.addEventListener('click', connect);
    copyInvite.addEventListener('click', copyToClipboard);

    function startTimer() { if (timerInterval) return; callStartTime = Date.now(); timerInterval = setInterval(() => { const diff = Date.now() - callStartTime; const m = String(Math.floor(diff / 60000)).padStart(2,'0'); const s = String(Math.floor((diff % 60000) / 1000)).padStart(2,'0'); callTimer.textContent = `${m}:${s}`; }, 1000); }
    function stopTimer() { clearInterval(timerInterval); timerInterval = null; callTimer.textContent = '00:00'; }

    async function startStats() {
      stopStats();
      statsInterval = setInterval(async () => {
        if (!pc) return;
        try {
          const stats = await pc.getStats(null); let bitrate = 0, packetsLost = 0, packetsTotal = 0;
          stats.forEach(report => {
            if (report.type === 'outbound-rtp' && !report.isRemote && report.mediaType === 'video') {
              if (report.bytesSentPrev !== undefined) { 
                const deltaBytes = report.bytesSent - report.bytesSentPrev; 
                const deltaTime = report.timestamp - report.timestampPrev; 
                bitrate = Math.floor((deltaBytes * 8) / (deltaTime / 1000)); 
              }
              report.bytesSentPrev = report.bytesSent; report.timestampPrev = report.timestamp;
            }
            if (report.type === 'remote-inbound-rtp' && report.mediaType === 'video') { packetsLost = report.packetsLost || 0; packetsTotal = (report.packetsReceived || 0) + packetsLost; }
          });
          const loss = packetsTotal ? Math.round((packetsLost / packetsTotal) * 100) : 0; 
          const kbps = bitrate ? `${(bitrate/1000).toFixed(1)} kbps` : '‚Äî';
          connectionQuality.textContent = `${kbps} | ${loss}%`;
          if (loss > 10 || bitrate < 300000) connectionQuality.className = 'px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs bg-rose-500/20 border border-rose-400/50 text-rose-100 hidden sm:inline-block';
          else if (loss > 3) connectionQuality.className = 'px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs bg-amber-500/20 border border-amber-400/50 text-amber-100 hidden sm:inline-block';
          else connectionQuality.className = 'px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs bg-emerald-500/20 border border-emerald-400/50 text-emerald-100 hidden sm:inline-block';
        } catch (e) { console.warn('Stats error', e); }
      }, 2000);
    }
    function stopStats() { clearInterval(statsInterval); statsInterval = null; connectionQuality.textContent = '–°–∫–æ—Ä–æ—Å—Ç—å: ‚Äî'; }

    function initAudioMeter(stream) {
      const ctx = new AudioContext(); const analyser = ctx.createAnalyser(); analyser.fftSize = 256; 
      const source = ctx.createMediaStreamSource(stream); source.connect(analyser); 
      const dataArray = new Uint8Array(analyser.frequencyBinCount); 
      const update = () => { analyser.getByteFrequencyData(dataArray); let sum = 0; for (let i = 0; i < dataArray.length; i++) sum += dataArray[i]; const level = Math.min(100, Math.max(3, Math.floor((sum / dataArray.length) / 2))); levelEl.style.height = `${level}%`; requestAnimationFrame(update); }; 
      update();
    }

    function openViewer(content) { viewerBody.innerHTML = ''; viewerBody.appendChild(content); viewer.classList.add('show'); }
    viewerClose.addEventListener('click', () => viewer.classList.remove('show'));
    viewer.addEventListener('click', (e) => { if (e.target === viewer) viewer.classList.remove('show'); });
    chat.addEventListener('click', (e) => {
      const img = e.target.closest('img[data-full]');
      if (img) { const big = document.createElement('img'); big.src = img.dataset.full; openViewer(big); }
    });

    // Tooltips - only on non-touch devices
    if (!('ontouchstart' in window)) {
      let tipTimer = null;
      document.addEventListener('mouseover', (e) => {
        const target = e.target.closest('[data-tip]'); if (!target) return;
        clearTimeout(tipTimer);
        tipTimer = setTimeout(() => {
          const text = target.getAttribute('data-tip'); tooltip.textContent = text; tooltip.classList.add('show');
          const rect = target.getBoundingClientRect(); tooltip.style.left = Math.max(8, rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px'; tooltip.style.top = rect.top - tooltip.offsetHeight - 8 + 'px';
        }, 1000);
      });
      document.addEventListener('mouseout', () => { if (tipTimer) clearTimeout(tipTimer); tooltip.classList.remove('show'); });
    }

    // Initialize modal elements
    const micInstructionModal = document.getElementById('micInstructionModal');
    const closeMicInstruction = document.getElementById('closeMicInstruction');
    const refreshPage = document.getElementById('refreshPage');
    
    // Modal event handlers
    closeMicInstruction.addEventListener('click', () => {
      micInstructionModal.classList.remove('show');
    });
    
    refreshPage.addEventListener('click', () => {
      window.location.reload();
    });
    
    micInstructionModal.addEventListener('click', (e) => {
      if (e.target === micInstructionModal) {
        micInstructionModal.classList.remove('show');
      }
    });
    
    // Function to show mic instruction
    function showMicInstruction() {
      micInstructionModal.classList.add('show');
    }
    
    // Initialize media on page load
    updateMediaButtons(); 
    setStatus('–û–∂–∏–¥–∞–Ω–∏–µ');
    
    // Auto-start camera on load
    startCamera().then(success => {
      if (!success) {
        showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      } else {
        // Check if using fallback audio (mic not working)
        if (localStream && localStream.getAudioTracks().some(t => t === fallbackAudioTrack)) {
          showNotification('‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ üé§ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.'); 
        }
      }
    });
  </script>
</body>
</html>
